name: Tag and release on push to main

on:
  push:
    branches:
      - main

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    # Needed so the action can push tags and create releases.
    permissions:
      contents: write

    steps:
      - name: Checkout repository with tags
        uses: actions/checkout@v4
        with:
          # Full history so github-tag-action can see previous tags
          # and compute the next semantic version.
          fetch-depth: 0

      - name: Bump version and create tag from Conventional Commits
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Do not set default_bump so commit messages decide the bump:
          # - feat:            -> minor
          # - fix:             -> patch
          # - feat!/fix!/BREAKING CHANGE -> major
          #
          # Tags are plain SemVer (e.g. 0.1.0), no "v" prefix.
          # Limit releases to the main branch.
          release_branches: main

      - name: Create GitHub Release with generated notes
        # Only create a release if a new tag was produced.
        if: ${{ steps.tag_version.outputs.new_tag != '' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}

          # Let GitHub generate release notes from commits/PRs.
          # This uses the "Generate release notes" feature, not the changelog body.
          generateReleaseNotes: true
