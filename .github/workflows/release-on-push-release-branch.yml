name: Tag and release on release-branch push

on:
  push:
    branches:
      - main
      - rc
      - beta
      - alpha

jobs:
  # ----------------------------
  # Stable releases from main
  # ----------------------------
  release:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    # Needed so the action can push tags and create releases.
    permissions:
      contents: write

    steps:
      - name: Checkout repository with tags
        uses: actions/checkout@v4
        with:
          # Full history so github-tag-action can see previous tags
          # and compute the next semantic version.
          fetch-depth: 0

      - name: Bump version and create tag from Conventional Commits
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          tag_prefix: ""

          # Only main is a stable release branch.
          release_branches: main

          # Normal semver behaviour on main.
          default_bump: patch
          # default_prerelease_bump is irrelevant here.
          default_prerelease_bump: prerelease

      - name: Create GitHub Release with generated notes
        if: ${{ steps.tag_version.outputs.new_tag != '' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}
          generateReleaseNotes: true
          # Stable release, not a prerelease.
          prerelease: false
          # Use default 'legacy' latest behaviour.

  # ----------------------------
  # Pre-releases from alpha/beta/rc
  # ----------------------------
  prerelease:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository with tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump prerelease version and create tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          tag_prefix: ""

          # We still consider only main as “stable”.
          release_branches: main

          # Pre-release branches we care about:
          pre_release_branches: rc,beta,alpha

          # Don’t auto-start a new major/minor/patch series.
          default_bump: false
          default_prerelease_bump: false

          # Bump just the pre-release identifier:
          # e.g. 1.0.0-alpha.3 -> 1.0.0-alpha.4
          custom_release_rules: "feat:prerelease,fix:prerelease,*!:prerelease,breaking:prerelease"

      - name: Create GitHub pre-release with generated notes
        if: ${{ steps.tag_version.outputs.new_tag != '' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}
          generateReleaseNotes: true

          # Mark as a prerelease in GitHub UI
          prerelease: true

          # Optional: don’t let this become the “Latest release” badge
          makeLatest: "false"
