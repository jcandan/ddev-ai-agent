name: Tag and release on release-branch push

on:
  push:
    branches:
      - main
      - rc
      - beta
      - alpha

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    # Needed so the action can push tags and create releases.
    permissions:
      contents: write

    steps:
      - name: Checkout repository with tags
        uses: actions/checkout@v4
        with:
          # Full history so github-tag-action can see previous tags
          # and compute the next semantic version.
          fetch-depth: 0

      - name: Determine release channel
        id: channel
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # Default to stable (main)
          if [[ "$BRANCH" == "main" ]]; then
            echo "pre=false" >> $GITHUB_OUTPUT
            echo "suffix=" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "rc" ]]; then
            echo "pre=true" >> $GITHUB_OUTPUT
            echo "suffix=rc" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "beta" ]]; then
            echo "pre=true" >> $GITHUB_OUTPUT
            echo "suffix=beta" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "alpha" ]]; then
            echo "pre=true" >> $GITHUB_OUTPUT
            echo "suffix=alpha" >> $GITHUB_OUTPUT
          else
            # Should never happen because trigger filters branches.
            echo "pre=false" >> $GITHUB_OUTPUT
            echo "suffix=" >> $GITHUB_OUTPUT
          fi

      - name: Bump version and create tag from Conventional Commits
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Let commit messages decide bump:
          # - feat:            -> minor
          # - fix:             -> patch
          # - feat!/fix!/BREAKING CHANGE -> major
          #
          # Tags are plain SemVer (e.g. 0.1.0), no "v" prefix.
          tag_prefix: ""

          # Stable releases come from main.
          # Pre-releases come from rc / beta / alpha.
          pre_release: ${{ steps.channel.outputs.pre }}
          pre_release_suffix: ${{ steps.channel.outputs.suffix }}

          # Only treat these branches as release branches.
          release_branches: |
            main
            rc
            beta
            alpha

      - name: Create GitHub Release with generated notes
        # Only create a release if a new tag was produced.
        if: ${{ steps.tag_version.outputs.new_tag != '' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}

          # Let GitHub generate release notes from commits/PRs.
          # This uses the "Generate release notes" feature, not the changelog body.
          generateReleaseNotes: true
