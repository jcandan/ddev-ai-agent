name: Tag and release on release-branch push

on:
  push:
    branches:
      - main
      - rc
      - beta
      - alpha

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    # Needed so the action can push tags and create releases.
    permissions:
      contents: write

    steps:
      - name: Checkout repository with tags
        uses: actions/checkout@v4
        with:
          # Full history so github-tag-action can see previous tags
          # and compute the next semantic version.
          fetch-depth: 0

      - name: Bump version and create tag from Conventional Commits
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Let commit messages decide bump:
          # - feat:            -> minor
          # - fix:             -> patch
          # - feat!/fix!/BREAKING CHANGE -> major
          #
          # Tags are plain SemVer (e.g. 0.1.0), no "v" prefix.
          tag_prefix: ""

          # Only main is "stable"
          release_branches: main

          # These are treated as pre-release branches
          pre_release_branches: rc,beta,alpha

          # Optional: only create a tag when commits demand a release
          default_bump: false

          default_prerelease_bump: prerelease

      - name: Create GitHub Release with generated notes
        # Only create a release if a new tag was produced.
        if: ${{ steps.tag_version.outputs.new_tag != '' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}

          # Let GitHub generate release notes from commits/PRs.
          # This uses the "Generate release notes" feature, not the changelog body.
          generateReleaseNotes: true
